rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get user profile (cached to avoid multiple reads)
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is super admin
    // Check user profile document for email and role
    // Note: Firestore caches get() calls, so calling getUserProfile() twice is optimized
    function isSuperAdmin() {
      // Check if user document exists, then check email and role
      // User document has email: "sroy@worksidesoftware.com" and role: "super_admin"
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (getUserProfile().email == 'sroy@worksidesoftware.com' || 
              getUserProfile().role == 'super_admin');
    }
    
    // Helper function to check if user is company owner
    function isCompanyOwner(companyId) {
      return companyId != null &&
             exists(/databases/$(database)/documents/companies/$(companyId)) &&
             get(/databases/$(database)/documents/companies/$(companyId)).data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if user is company admin or supervisor
    function isCompanyAdminOrSupervisor() {
      return isSuperAdmin() || 
             getUserProfile().role == 'admin' || 
             getUserProfile().role == 'supervisor';
    }
    
    // Users collection - users can only access their own data
    // Super admin can read all users (needed for batch queries)
    match /users/{userId} {
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        request.auth.uid == userId ||
        (isCompanyAdminOrSupervisor() &&
         resource.data.companyId != null &&
         resource.data.companyId == getUserProfile().companyId)
      );
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Customers collection - role-based access
    match /customers/{customerId} {
      // Allow read:
      // - Owner of the customer
      // - Super admin (can read all customers - check first to bypass company checks)
      // - Any user in the same company (companyId match) - field techs, admins, supervisors
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        resource.data.userId == request.auth.uid ||
        (resource.data.companyId != null &&
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // Allow create:
      // - Any authenticated user (status determined by role in application logic)
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Allow update:
      // - Super admin (can update any customer - check first)
      // - Owner of pending customer (field tech can edit their own pending)
      // - Company admin/supervisor for same company
      allow update: if request.auth != null && (
        isSuperAdmin() ||
        (resource.data.status == 'pending' && 
         resource.data.createdBy == request.auth.uid) ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // Allow delete:
      // - Super admin (can delete any customer - check first)
      // - Company admin/supervisor for same company
      allow delete: if request.auth != null && (
        isSuperAdmin() ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId)
      );
    }
    
    // Jobs collection - company-based access
    match /jobs/{jobId} {
      // Allow read:
      // - Super admin can read all jobs
      // - Users can read jobs in their company
      // - Users can read jobs they created
      // - Users can read jobs assigned to them
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        (resource.data.companyId != null &&
         resource.data.companyId == getUserProfile().companyId) ||
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid
      );
      
      // Allow create: authenticated users creating jobs for their company
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        (isSuperAdmin() ||
         request.resource.data.companyId == getUserProfile().companyId);
      
      // Allow update:
      // - Super admin
      // - Job creator
      // - Assigned technician (can update status, notes, etc.)
      // - Company admins/supervisors
      allow update: if request.auth != null && (
        isSuperAdmin() ||
        resource.data.userId == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid ||
        (isCompanyAdminOrSupervisor() &&
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // Allow delete:
      // - Super admin
      // - Job creator
      // - Company admins/supervisors
      allow delete: if request.auth != null && (
        isSuperAdmin() ||
        resource.data.userId == request.auth.uid ||
        (isCompanyAdminOrSupervisor() &&
         resource.data.companyId == getUserProfile().companyId)
      );
    }
    
    // Appointments collection - users can only access their own appointments
    match /appointments/{appointmentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Photos collection - users can only access their own photos
    match /photos/{photoId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Estimates collection - users can only access their own estimates
    match /estimates/{estimateId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Allow read: 
      // - Any authenticated user can read companies (needed for code lookups and uniqueness checks)
      // - Unauthenticated users can read active companies (needed for signup code validation)
      // Company data (name, address, etc.) is not highly sensitive
      // Only allow unauthenticated reads for active companies (prevents reading inactive/deleted companies)
      allow read: if request.auth != null || 
                   (resource.data.isActive == true && 
                    resource.data.code != null);
      
      // Allow write (update/delete) only for own company
      allow write: if request.auth != null && (
        isSuperAdmin() ||
        request.auth.uid == resource.data.ownerId
      );
      
      // Allow create: anyone authenticated can create a company (they become owner)
      allow create: if request.auth != null && (
        isSuperAdmin() ||
        request.auth.uid == request.resource.data.ownerId
      );
    }
    
    // Team Members collection - users can access if they own the company
    match /teamMembers/{teamMemberId} {
      // Allow read: super admin or users viewing team members within their company
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        (resource.data.companyId != null &&
         resource.data.companyId == getUserProfile().companyId) ||
        (resource.data.userId != null &&
         resource.data.userId == request.auth.uid) ||
        (resource.data.invitedBy != null &&
         resource.data.invitedBy == request.auth.uid)
      );

      // Allow create: inviter, company owner, or super admin
      allow create: if request.auth != null && (
        request.auth.uid == request.resource.data.invitedBy ||
        isSuperAdmin() ||
        isCompanyOwner(request.resource.data.companyId) ||
        (
          request.resource.data.companyId != null &&
          getUserProfile().companyId == request.resource.data.companyId &&
          (getUserProfile().role == 'admin' || getUserProfile().role == 'supervisor')
        )
      );

      // Allow update/delete: inviter, company owner, or super admin
      allow update, delete: if request.auth != null && (
        request.auth.uid == resource.data.invitedBy ||
        isSuperAdmin() ||
        isCompanyOwner(resource.data.companyId)
      );
    }
    
    // Invitations collection - company admins and super admin can manage invitations
    match /invitations/{invitationId} {
      // Allow read: super admin (first) or company admins/supervisors for same company
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId) ||
        (resource.data.invitedBy != null && resource.data.invitedBy == request.auth.uid)
      );
      
      // Allow create: super admin (first) or company admins/supervisors
      allow create: if request.auth != null && (
        isSuperAdmin() ||
        request.auth.uid == request.resource.data.invitedBy ||
        isCompanyOwner(request.resource.data.companyId) ||
        (
          request.resource.data.companyId != null &&
          getUserProfile().companyId == request.resource.data.companyId &&
          (getUserProfile().role == 'admin' || getUserProfile().role == 'supervisor')
        )
      );
      
      // Allow update/delete: super admin (first) or company admins/supervisors
      allow update, delete: if request.auth != null && (
        isSuperAdmin() ||
        request.auth.uid == resource.data.invitedBy ||
        isCompanyOwner(resource.data.companyId)
      );
    }
    
    // Estimate Templates collection - users can only access their own templates
    match /estimateTemplates/{templateId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Invoices collection - users can only access their own invoices
    match /invoices/{invoiceId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Recurring Jobs collection - users can only access their own recurring jobs
    // Super admin can access all recurring jobs
    match /recurringJobs/{recurringJobId} {
      // Allow read: check super admin first (for better performance on bulk queries)
      // IMPORTANT: When querying without where clause, Firestore evaluates this for each document
      // So isSuperAdmin() must be efficient and reliable
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        resource.data.userId == request.auth.uid
      );
      allow write: if request.auth != null && (
        isSuperAdmin() ||
        resource.data.userId == request.auth.uid
      );
      allow create: if request.auth != null && (
        isSuperAdmin() ||
        request.resource.data.userId == request.auth.uid
      );
    }
    
    // Locations collection - GPS tracking data
    match /locations/{locationId} {
      // Allow create: users can create their own location data
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Allow read:
      // - Owner of the location
      // - Company admin/supervisor for same company
      // - Super admin
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isSuperAdmin() ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // No updates or deletes allowed (immutable tracking data)
      allow update, delete: if false;
    }
    
    // Work Sessions collection - tracking sessions
    match /workSessions/{sessionId} {
      // Allow create: users can create their own work sessions
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Allow read:
      // - Owner of the session
      // - Company admin/supervisor for same company
      // - Super admin
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isSuperAdmin() ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // Allow update: only owner can update their own session
      allow update: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      
      // No deletes allowed
      allow delete: if false;
    }
    
    // Materials collection - company-specific materials list
    match /materials/{materialId} {
      // Allow read: 
      // - Super admin can read all materials (check first for efficiency)
      // - Regular users (including technicians) can read their company's materials
      // Note: Technicians need to see active materials for job completion
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        (resource.data.companyId != null && 
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // Allow write (create/update/delete): only admin/supervisor/super_admin
      allow write: if request.auth != null && (
        isSuperAdmin() ||
        (isCompanyAdminOrSupervisor() && 
         request.resource.data.companyId != null &&
         request.resource.data.companyId == getUserProfile().companyId)
      );
    }
    
    // Job Materials collection - materials used on jobs
    match /jobMaterials/{jobMaterialId} {
      // Allow read: all authenticated users (for job details and invoicing)
      allow read: if request.auth != null;
      
      // Allow create: admin/technician/super_admin
      allow create: if request.auth != null && (
        isSuperAdmin() ||
        isCompanyAdminOrSupervisor() ||
        request.resource.data.technicianId == request.auth.uid
      );
      
      // Allow update/delete: only admin/super_admin (technicians can't modify after creation)
      allow update, delete: if request.auth != null && (
        isSuperAdmin() ||
        isCompanyAdminOrSupervisor()
      );
    }

    // Job Photos collection - images associated with jobs
    match /jobPhotos/{photoId} {
      // Allow read: super admin or any user within the same company context
      allow read: if request.auth != null && (
        isSuperAdmin() ||
        (
          resource.data.companyId != null &&
          resource.data.companyId == getUserProfile().companyId
        )
      );

      // Allow create: super admin or user uploading within their own company
      allow create: if request.auth != null && (
        isSuperAdmin() ||
        (
          request.resource.data.companyId != null &&
          request.resource.data.companyId == getUserProfile().companyId &&
          request.resource.data.uploadedBy == request.auth.uid
        ) &&
        (
          request.resource.data.capturedAt == null ||
          request.resource.data.capturedAt is timestamp ||
          (
            request.resource.data.capturedAt is string &&
            request.resource.data.capturedAt.matches('^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$')
          )
        ) &&
        (
          (
            request.resource.data.latitude == null &&
            request.resource.data.longitude == null
          ) ||
          (
            request.resource.data.latitude is number &&
            request.resource.data.longitude is number &&
            request.resource.data.latitude >= -90 &&
            request.resource.data.latitude <= 90 &&
            request.resource.data.longitude >= -180 &&
            request.resource.data.longitude <= 180
          )
        ) &&
        (
          request.resource.data.locationAccuracy == null ||
          (
            request.resource.data.locationAccuracy is number &&
            request.resource.data.locationAccuracy >= 0 &&
            request.resource.data.locationAccuracy <= 1000
          )
        ) &&
        (
          request.resource.data.note == null ||
          (
            request.resource.data.note is string &&
            request.resource.data.note.size() <= 500
          )
        )
      );

      // Allow update: uploader, company admin/supervisor, or super admin
      allow update: if request.auth != null && (
        isSuperAdmin() ||
        (
          resource.data.companyId != null &&
          resource.data.companyId == getUserProfile().companyId &&
          (
            resource.data.uploadedBy == request.auth.uid ||
            isCompanyAdminOrSupervisor()
          )
        ) &&
        (
          request.resource.data.capturedAt == null ||
          request.resource.data.capturedAt is timestamp ||
          (
            request.resource.data.capturedAt is string &&
            request.resource.data.capturedAt.matches('^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$')
          )
        ) &&
        (
          (
            request.resource.data.latitude == null &&
            request.resource.data.longitude == null
          ) ||
          (
            request.resource.data.latitude is number &&
            request.resource.data.longitude is number &&
            request.resource.data.latitude >= -90 &&
            request.resource.data.latitude <= 90 &&
            request.resource.data.longitude >= -180 &&
            request.resource.data.longitude <= 180
          )
        ) &&
        (
          request.resource.data.locationAccuracy == null ||
          (
            request.resource.data.locationAccuracy is number &&
            request.resource.data.locationAccuracy >= 0 &&
            request.resource.data.locationAccuracy <= 1000
          )
        ) &&
        (
          request.resource.data.note == null ||
          (
            request.resource.data.note is string &&
            request.resource.data.note.size() <= 500
          )
        )
      );

      // Allow delete: uploader, company admin/supervisor, or super admin
      allow delete: if request.auth != null && (
        isSuperAdmin() ||
        (
          resource.data.companyId != null &&
          resource.data.companyId == getUserProfile().companyId &&
          (
            resource.data.uploadedBy == request.auth.uid ||
            isCompanyAdminOrSupervisor()
          )
        )
      );
    }
  }
}