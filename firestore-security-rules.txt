rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to get user profile
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is super admin
    function isSuperAdmin() {
      return getUserProfile().email == 'sroy@worksidesoftware.com' || 
             getUserProfile().role == 'super_admin';
    }
    
    // Helper function to check if user is company admin or supervisor
    function isCompanyAdminOrSupervisor() {
      return isSuperAdmin() || 
             getUserProfile().role == 'admin' || 
             getUserProfile().role == 'supervisor';
    }
    
    // Customers collection - role-based access
    match /customers/{customerId} {
      // Allow read:
      // - Owner of the customer
      // - Super admin
      // - Company admin/supervisor for same company
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isSuperAdmin() ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId)
      );
      
      // Allow create:
      // - Any authenticated user (status determined by role in application logic)
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
      
      // Allow update:
      // - Owner of pending customer (field tech can edit their own pending)
      // - Company admin/supervisor for same company
      // - Super admin
      allow update: if request.auth != null && (
        (resource.data.status == 'pending' && 
         resource.data.createdBy == request.auth.uid) ||
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId) ||
        isSuperAdmin()
      );
      
      // Allow delete:
      // - Company admin/supervisor for same company
      // - Super admin
      allow delete: if request.auth != null && (
        (isCompanyAdminOrSupervisor() && 
         resource.data.companyId == getUserProfile().companyId) ||
        isSuperAdmin()
      );
    }
    
    // Jobs collection - users can only access their own jobs
    match /jobs/{jobId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Appointments collection - users can only access their own appointments
    match /appointments/{appointmentId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Photos collection - users can only access their own photos
    match /photos/{photoId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Estimates collection - users can only access their own estimates
    match /estimates/{estimateId} {
      allow read, write: if request.auth != null && 
        request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Companies collection
    match /companies/{companyId} {
      // Allow read: any authenticated user can read companies (needed for code lookups and uniqueness checks)
      // Company data (name, address, etc.) is not highly sensitive
      allow read: if request.auth != null;
      
      // Allow write (update/delete) only for own company
      allow write: if request.auth != null && 
        request.auth.uid == resource.data.ownerId;
      
      // Allow create: anyone authenticated can create a company (they become owner)
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.ownerId;
    }
    
        // Team Members collection - users can access if they own the company
        match /teamMembers/{teamMemberId} {
          allow read, write: if request.auth != null && 
            request.auth.uid == get(/databases/$(database)/documents/companies/$(resource.data.companyId)).data.ownerId;
          allow create: if request.auth != null && 
            request.auth.uid == get(/databases/$(database)/documents/companies/$(request.resource.data.companyId)).data.ownerId;
        }
        
        // Estimate Templates collection - users can only access their own templates
        match /estimateTemplates/{templateId} {
          allow read, write: if request.auth != null && 
            request.auth.uid == resource.data.userId;
          allow create: if request.auth != null && 
            request.auth.uid == request.resource.data.userId;
        }
        
        // Invoices collection - users can only access their own invoices
        match /invoices/{invoiceId} {
          allow read, write: if request.auth != null && 
            request.auth.uid == resource.data.userId;
          allow create: if request.auth != null && 
            request.auth.uid == request.resource.data.userId;
        }
        
        // Recurring Jobs collection - users can only access their own recurring jobs
        match /recurringJobs/{recurringJobId} {
          allow read, write: if request.auth != null && 
            request.auth.uid == resource.data.userId;
          allow create: if request.auth != null && 
            request.auth.uid == request.resource.data.userId;
        }
        
        // Locations collection - GPS tracking data
        match /locations/{locationId} {
          // Allow create: users can create their own location data
          allow create: if request.auth != null && 
            request.auth.uid == request.resource.data.userId;
          
          // Allow read:
          // - Owner of the location
          // - Company admin/supervisor for same company
          // - Super admin
          allow read: if request.auth != null && (
            resource.data.userId == request.auth.uid ||
            isSuperAdmin() ||
            (isCompanyAdminOrSupervisor() && 
             resource.data.companyId == getUserProfile().companyId)
          );
          
          // No updates or deletes allowed (immutable tracking data)
          allow update, delete: if false;
        }
        
        // Work Sessions collection - tracking sessions
        match /workSessions/{sessionId} {
          // Allow create: users can create their own work sessions
          allow create: if request.auth != null && 
            request.auth.uid == request.resource.data.userId;
          
          // Allow read:
          // - Owner of the session
          // - Company admin/supervisor for same company
          // - Super admin
          allow read: if request.auth != null && (
            resource.data.userId == request.auth.uid ||
            isSuperAdmin() ||
            (isCompanyAdminOrSupervisor() && 
             resource.data.companyId == getUserProfile().companyId)
          );
          
          // Allow update: only owner can update their own session
          allow update: if request.auth != null && 
            resource.data.userId == request.auth.uid;
          
          // No deletes allowed
          allow delete: if false;
        }
      }
    }